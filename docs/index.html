<!doctype html>
<html>
<head>
  <meta charset="utf8" />
  <title>Search for openjdk mailing lists</title>
  <link rel="icon" type="image/x-icon" href="https://hixon10.github.io/openjdk-mailing-lists-search/favicon.ico">
</head>

<script src='https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-asm-debug.js'></script>
<script>
  config = {
    locateFile: (filename, prefix) => {
      console.log(`prefix is : ${prefix}`);
      return 'https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.wasm';
    }
  }
  // The `initSqlJs` function is globally provided by all of the main dist files if loaded in the browser.
  // We must specify this locateFile function if we are loading a wasm file from anywhere other than the current html page's folder.
  const sqlPromise = initSqlJs(config);

  // Open a database
  const databaseUrlPrefix = "https://hixon10.github.io/openjdk-mailing-lists-search/";
  const databasePartNames = ["db-part-00", "db-part-01", "db-part-02", "db-part-03", "db-part-04", "db-part-05", "db-part-06", "db-part-07", "db-part-08", "db-part-09"];
  
  const databasePartPromises = [];
  
  for (const dbPartName of databasePartNames) {
  	// disable cache https://stackoverflow.com/a/59493583/1756750
  	const ms = Date.now();
  	const currentPartUrl = databaseUrlPrefix+dbPartName+"?dummy="+ms;
  	const currentDbPartPromise = fetch(currentPartUrl, {
  		  headers: {
  			'Cache-Control': 'no-cache',
  			'pragma': 'no-cache'
  		  }
  		}).then(res => res.arrayBuffer())
  		  .then(buf => new Uint8Array(buf));
  	databasePartPromises.push(currentDbPartPromise);
  }
  
  console.log("Start downloading a database...");

  const dataPromise = Promise.all(databasePartPromises);
  
  Promise.all([sqlPromise, dataPromise]).then((values) => {
    const SQL = values[0];
	const databaseParts = values[1];
	
	// https://stackoverflow.com/a/49129872/1756750
	  let length = 0;
	  databaseParts.forEach(item => {
		  length += item.length;
	  });
	  
	  let mergedArray = new Uint8Array(length);
	  let offset = 0;
	  databaseParts.forEach(item => {
		  mergedArray.set(item, offset);
		  offset += item.length;
	  });

	const db = new SQL.Database(mergedArray);

	var stmt = db.prepare("SELECT count(*) FROM emails");

	while (stmt.step()) { //
	  var row = stmt.getAsObject();
	  console.log('Here is a row: ' + JSON.stringify(row));
	}
  });
</script>

<body>
  Output is in Javscript console, wait for some time
</body>

</html>